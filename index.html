<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faceless Creator Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        .game-container {
            background-color: #16213e;
            border: 1px solid #0f3460;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .btn {
            transition: all 0.3s ease;
        }
        .btn-primary {
            background-color: #e94560;
            color: white;
        }
        .btn-primary:hover {
            background-color: #ff6e7f;
        }
        .btn-secondary {
            background-color: #533483;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #6f42c1;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .card:hover:not(.opacity-50) {
            border-color: #e94560;
            transform: translateY(-5px);
        }
        .stat-card {
            background-color: #0f3460;
        }
        .progress-bar-bg {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .progress-bar-fill {
            background-color: #e94560;
            transition: width 0.5s ease;
        }
        .hidden { display: none; }
        
        .loader-sm {
            width: 16px;
            height: 16px;
            border: 2px solid #FFF;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .loader-lg {
            width: 60px;
            height: 60px;
            border: 5px solid #FFF;
            border-bottom-color: #e94560;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center min-h-screen">

    <div id="publishing-overlay" class="hidden fixed inset-0 bg-black/80 flex flex-col items-center justify-center z-50">
        <div class="loader-lg"></div>
        <p class="text-white text-xl mt-4 font-semibold animate-pulse">Publicando Video...</p>
    </div>

    <div id="game-container" class="game-container w-full max-w-4xl mx-auto p-6 md:p-8 rounded-2xl">
        
        <div id="email-registration-screen" class="hidden text-center">
            <h2 class="text-2xl font-bold mb-4">¡Bienvenido al Simulador!</h2>
            <p class="text-sm text-gray-300 mb-4 text-center">Para guardar tu progreso y participar, por favor ingresa tu correo electrónico.</p>
            <p id="email-error" class="text-red-400 text-sm mb-4 hidden"></p>
            <input type="email" id="email-input" class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-3 text-center mb-4" placeholder="tu@email.com">
            <button id="save-email-btn" class="btn btn-primary font-bold py-2 px-6 rounded-lg">Continuar</button>
        </div>
        
        <div id="api-key-screen" class="hidden text-center">
            <h2 class="text-2xl font-bold mb-4">API Key de Google AI (Opcional)</h2>
            <p class="text-sm text-gray-300 mb-4 text-center">Para usar la IA y tener la mejor experiencia, puedes usar tu propia API Key.<br>
              <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-pink-400 underline">Consíguela aquí</a>
            </p>
            <p id="api-key-error" class="text-red-400 text-sm mb-4 hidden"></p>
            <input type="password" id="api-key-input" class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-3 text-center mb-4" placeholder="Pega tu API Key aquí">
            <button id="save-api-key-btn" class="btn btn-primary font-bold py-2 px-6 rounded-lg">Guardar y Continuar</button>
            <button id="skip-api-key-btn" class="block w-full text-sm text-gray-400 underline mt-4">Continuar sin funciones de IA</button>
        </div>

        <div id="continue-prompt-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold mb-4">¡Bienvenido de vuelta!</h2>
            <p class="text-lg text-gray-300 mb-8">Hemos encontrado una partida guardada. ¿Quieres continuar o empezar de nuevo?</p>
            <div class="flex justify-center gap-4">
                <button id="continue-game-btn" class="btn btn-primary font-bold py-3 px-8 rounded-lg">Continuar Partida</button>
                <button id="new-game-btn" class="btn btn-secondary font-bold py-3 px-8 rounded-lg">Empezar de Nuevo</button>
            </div>
        </div>

        <div id="start-screen" class="hidden text-center">
            <h1 class="text-4xl md:text-5xl font-bold mb-4 text-white">Faceless Creator Simulator</h1>
            <p class="text-lg text-gray-300 mb-8">¿Tienes lo necesario para triunfar sin mostrar tu rostro? ¡Elige tu nicho, crea contenido viral y construye tu imperio!</p>
            <button id="start-game-btn" class="btn btn-primary font-bold py-3 px-8 rounded-lg text-xl">Comenzar Aventura</button>
        </div>

        <div id="niche-selection-screen" class="hidden">
            <h2 class="text-2xl font-bold text-center mb-6">Paso 1: Elige tu Nicho</h2>
            <div id="niche-options" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </div>
        
        <div id="main-game-screen" class="hidden">
            <div id="progress-container" class="mb-6"></div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card p-4 rounded-lg text-center"><div class="text-sm text-gray-400">Seguidores</div><div id="followers-stat" class="text-2xl font-bold">0</div></div>
                <div class="stat-card p-4 rounded-lg text-center"><div class="text-sm text-gray-400">Dinero</div><div id="money-stat" class="text-2xl font-bold">$500</div></div>
                <div class="stat-card p-4 rounded-lg text-center"><div class="text-sm text-gray-400">Videos</div><div id="videos-stat" class="text-2xl font-bold">0</div></div>
                <div class="stat-card p-4 rounded-lg text-center"><div class="text-sm text-gray-400">Nicho</div><div id="niche-stat" class="text-lg font-bold"></div></div>
            </div>

            <div id="content-area">
                <div id="idle-view" class="text-center p-8">
                    <h3 class="text-2xl font-semibold mb-4">¿Listo para crear?</h3>
                    <p class="mb-6">Es hora de producir tu próximo video viral. ¡Piensa en una idea y empecemos!</p>
                    <button id="create-video-btn" class="btn btn-primary font-bold py-3 px-8 rounded-lg text-lg">Crear Nuevo Video</button>
                </div>

                <div id="creation-view" class="hidden space-y-8">
                    <div>
                        <h3 class="text-xl font-bold mb-2">Paso 2: La Idea Ganadora 💡</h3>
                        <p class="text-sm text-gray-400 mb-4">Escribe tu idea o déjaselo a la IA. Una idea creativa atrae más seguidores.</p>
                        <textarea id="idea-input" class="w-full bg-gray-900/50 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-pink-500 focus:border-pink-500" placeholder="Ej: '3 hacks secretos de IA que nadie te cuenta...'"></textarea>
                        <button id="ai-idea-btn" class="btn btn-secondary text-sm px-4 py-2 mt-2 flex items-center gap-2 disabled:bg-gray-600">
                            <span class="btn-text">🤖 ✨ Usar idea de IA</span>
                            <span class="loader-sm hidden"></span>
                        </button>
                    </div>

                    <div>
                        <h3 class="text-xl font-bold mb-2">Paso 3: Elige tus Herramientas</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                           <div id="voice-tool-choices"><h4 class="font-semibold text-gray-300 mb-2">Calidad de Voz</h4></div>
                           <div id="visuals-tool-choices"><h4 class="font-semibold text-gray-300 mb-2">Calidad Visual</h4></div>
                        </div>
                    </div>
                     <div>
                        <h3 class="text-xl font-bold mb-2">Paso 4: Define la Estrategia</h3>
                        <div id="strategy-choices" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                    </div>
                    <div>
                         <button id="publish-video-btn" class="w-full btn btn-primary font-bold py-3 px-8 rounded-lg text-lg" disabled>Publicar Video</button>
                    </div>
                </div>

                <div id="results-view" class="hidden text-center p-6">
                    <h3 class="text-2xl font-bold mb-4">¡Video Publicado!</h3>
                    <div id="results-feedback" class="space-y-4"></div>
                    <button id="next-turn-btn" class="mt-8 btn btn-secondary font-bold py-3 px-8 rounded-lg text-lg">Crear Siguiente Video</button>
                </div>
            </div>
        </div>

        <div id="end-screen" class="hidden text-center">
             <h1 class="text-4xl md:text-5xl font-bold mb-4"></h1>
             <p class="text-lg text-gray-300 mb-8"></p>
             <button id="restart-game-btn" class="btn btn-primary font-bold py-3 px-8 rounded-lg text-xl">Jugar de Nuevo</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const NICHES = [
        { id: 'cooking', name: 'Cocina', icon: '🍳', description: 'Altamente visual, gran potencial viral.', popularity: 1.0, difficulty: 0.5, goal: 250000, startingMoney: 600 },
        { id: 'motivation', name: 'Motivación', icon: '✨', description: 'Requiere gran storytelling, muy compartible.', popularity: 0.9, difficulty: 0.6, goal: 500000, startingMoney: 550 },
        { id: 'finance', name: 'Finanzas', icon: '💰', description: 'Alto potencial de monetización, audiencia exigente.', popularity: 0.8, difficulty: 0.7, goal: 750000, startingMoney: 500 },
        { id: 'tech', name: 'Tecnología', icon: '💻', description: 'Constante necesidad de contenido nuevo, muy competido.', popularity: 0.9, difficulty: 0.8, goal: 750000, startingMoney: 450 },
        { id: 'history', name: 'Historia', icon: '📜', description: 'Requiere buena investigación, audiencia fiel.', popularity: 0.7, difficulty: 0.9, goal: 750000, startingMoney: 400 },
        { id: 'meta', name: 'Meta-Creador', icon: '🧑‍🏫', description: 'Enseñar a otros a ser \'faceless\'.', popularity: 0.7, difficulty: 1.0, goal: 1000000, startingMoney: 350 },
    ];
    const TOOLS = {
        voice: [ { id: 'v_human', name: 'Voz Humana (Propia)', cost: 0, quality: 5, authenticity: 10 }, { id: 'v_basic', name: 'Voz IA Genérica', cost: 10, quality: 3, authenticity: 1 }, { id: 'v_premium', name: 'Voz IA Premium', cost: 50, quality: 7, authenticity: 4 }, { id: 'v_clone', name: 'Voz IA Clonada', cost: 150, quality: 9, authenticity: 8 }, ],
        visuals: [ { id: 'vis_stock', name: 'Video de Stock Gratis', cost: 0, quality: 4, creativity: 2 }, { id: 'vis_premium', name: 'Stock Premium', cost: 60, quality: 7, creativity: 5 }, { id: 'vis_ai', name: 'B-Roll con IA', cost: 120, quality: 9, creativity: 9 }, ]
    };
    const STRATEGIES = {
        hook: [ { id: 'h_weak', name: 'Gancho Débil', text: '"Hola a todos, en este video..."', effectiveness: 2 }, { id: 'h_ok', name: 'Gancho Aceptable', text: '"Hoy vamos a aprender sobre..."', effectiveness: 5 }, { id: 'h_strong', name: 'Gancho Fuerte', text: '"La mayoría se equivoca en esto..."', effectiveness: 9 }, { id: 'h_viral', name: 'Gancho Viral', text: '"No creerás este truco SECRETO..."', effectiveness: 10 }, ],
        authenticity: [ { id: 'a_generic', name: 'Guion 100% IA', text: 'Usar el guion tal como lo genera la IA. Rápido pero genérico.', authenticityBoost: 1, time: 1 }, { id: 'a_edited', name: 'Guion Editado', text: 'Editar el guion de la IA para añadir tu toque. Más auténtico.', authenticityBoost: 5, time: 3 }, { id: 'a_human', name: 'Guion Propio', text: 'Escribir tu propio guion. Máxima autenticidad pero lento.', authenticityBoost: 9, time: 6 }, ]
    };
    const TURN_COST = 10;
    let gameState = {};

    const ideaInput = document.getElementById('idea-input');
    const aiIdeaBtn = document.getElementById('ai-idea-btn');
    const publishingOverlay = document.getElementById('publishing-overlay');

    function resetGameState() {
        gameState = { followers: 0, money: 500, videos: 0, niche: null, goal: 1000000, ideaHistory: [], currentVideo: { idea: '', isAIIdea: false, voice: null, visuals: null, hook: null, authenticity: null, }, isGameOver: false, };
        saveGameState();
    }
    
    function showScreen(screenId) {
        ['email-registration-screen', 'api-key-screen', 'continue-prompt-screen', 'start-screen', 'niche-selection-screen', 'main-game-screen', 'end-screen'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(screenId).classList.remove('hidden');
    }
    function showView(viewId) {
        ['idle-view', 'creation-view', 'results-view'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(viewId).classList.remove('hidden');
    }
    
    function updateStats() {
        document.getElementById('followers-stat').textContent = gameState.followers.toLocaleString();
        document.getElementById('money-stat').textContent = `$${gameState.money.toLocaleString()}`;
        document.getElementById('videos-stat').textContent = gameState.videos;
        if (gameState.niche) {
            document.getElementById('niche-stat').textContent = gameState.niche.name;
        }

        const progressContainer = document.getElementById('progress-container');
        if (progressContainer && gameState.goal) {
            let percent = Math.min(100, Math.round((gameState.followers / gameState.goal) * 100));
            const goalText = (gameState.goal / 1000000) >= 1 ? `${gameState.goal / 1000000}M` : `${gameState.goal / 1000}K`;
            progressContainer.innerHTML = `
                <div class="w-full progress-bar-bg rounded-full h-4 relative">
                    <div class="progress-bar-fill h-4 rounded-full" style="width:${percent}%"></div>
                    <span class="absolute w-full text-center text-xs text-white font-bold" style="top:0; left:0;">${percent}% a ${goalText} de seguidores</span>
                </div>
            `;
        }
    }

    function renderNicheSelection() {
        const container = document.getElementById('niche-options');
        container.innerHTML = '';
        NICHES.forEach(niche => {
            const card = document.createElement('div');
            card.className = 'card p-6 rounded-lg cursor-pointer text-center flex flex-col justify-between h-full';
            let difficultyText = '';
            let difficultyReason = '';
            if (niche.difficulty >= 1.0) { difficultyText = 'Extrema'; difficultyReason = 'Mercado saturado; tu audiencia son otros creadores muy críticos.'; } 
            else if (niche.difficulty >= 0.8) { difficultyText = 'Difícil'; difficultyReason = 'Alta competencia y tendencias rápidas.'; } 
            else if (niche.difficulty >= 0.6) { difficultyText = 'Media'; difficultyReason = 'Requiere gran habilidad para conectar.'; } 
            else { difficultyText = 'Fácil'; difficultyReason = 'Atractivo universal y fácil de visualizar.'; }
            const goalText = (niche.goal / 1000000) >= 1 ? `${niche.goal / 1000000}M` : `${niche.goal / 1000}K`;
            card.innerHTML = `
                <div>
                    <div class="text-5xl mb-3">${niche.icon}</div>
                    <h3 class="text-xl font-bold mb-2">${niche.name}</h3>
                    <p class="text-sm text-gray-400">${niche.description}</p>
                </div>
                <div class="mt-4 pt-3 border-t border-white/10 space-y-2">
                    <p class="text-xs font-bold uppercase tracking-wider ${niche.difficulty >= 1.0 ? 'text-red-400' : 'text-pink-400'}">Dificultad: ${difficultyText}</p>
                    <p class="text-xs text-gray-500">${difficultyReason}</p>
                    <p class="text-xs font-semibold text-cyan-400">Meta: ${goalText} de Seguidores</p>
                </div>
            `;
            card.addEventListener('click', () => selectNiche(niche));
            container.appendChild(card);
        });
    }
    
    function renderCreationChoices() {
        const voiceContainer = document.getElementById('voice-tool-choices');
        voiceContainer.innerHTML = '<h4 class="font-semibold text-gray-300 mb-2">Calidad de Voz</h4>';
        TOOLS.voice.forEach(tool => {
            const card = document.createElement('div');
            card.className = 'card p-4 rounded-lg cursor-pointer mb-2';
            card.dataset.type = 'voice';
            card.innerHTML = `<div class="flex justify-between items-center"><span>${tool.name}</span><span class="font-bold text-lg ${gameState.money < tool.cost ? 'text-red-500' : 'text-green-400'}">-$${tool.cost}</span></div>`;
            if (gameState.money < tool.cost) { card.classList.add('opacity-50', 'cursor-not-allowed'); } else { card.addEventListener('click', () => selectChoice('voice', tool, card)); }
            voiceContainer.appendChild(card);
        });

        const visualsContainer = document.getElementById('visuals-tool-choices');
        visualsContainer.innerHTML = '<h4 class="font-semibold text-gray-300 mb-2">Calidad Visual</h4>';
        TOOLS.visuals.forEach(tool => {
            const card = document.createElement('div');
            card.className = 'card p-4 rounded-lg cursor-pointer mb-2';
            card.dataset.type = 'visuals';
            card.innerHTML = `<div class="flex justify-between items-center"><span>${tool.name}</span><span class="font-bold text-lg ${gameState.money < tool.cost ? 'text-red-500' : 'text-green-400'}">-$${tool.cost}</span></div>`;
            if (gameState.money < tool.cost) { card.classList.add('opacity-50', 'cursor-not-allowed'); } else { card.addEventListener('click', () => selectChoice('visuals', tool, card)); }
            visualsContainer.appendChild(card);
        });
        
        const strategyContainer = document.getElementById('strategy-choices');
        strategyContainer.innerHTML = `<div><h4 class="font-semibold text-gray-300 mb-2">Gancho (Hook)</h4>${STRATEGIES.hook.map(s => `<div class="card p-4 rounded-lg cursor-pointer mb-2" data-type="hook" data-id="${s.id}">${s.text}</div>`).join('')}</div><div><h4 class="font-semibold text-gray-300 mb-2">Autenticidad del Guion</h4>${STRATEGIES.authenticity.map(s => `<div class="card p-4 rounded-lg cursor-pointer mb-2" data-type="authenticity" data-id="${s.id}">${s.text}</div>`).join('')}</div>`;
        
        strategyContainer.querySelectorAll('.card').forEach(card => {
            card.addEventListener('click', () => { const type = card.dataset.type; const id = card.dataset.id; const choice = STRATEGIES[type].find(s => s.id === id); selectChoice(type, choice, card); });
        });

        ideaInput.addEventListener('input', () => { gameState.currentVideo.isAIIdea = false; ideaInput.disabled = false; aiIdeaBtn.style.borderColor = 'rgba(255, 255, 255, 0.1)'; checkCanPublish(); });
    
        if (!localStorage.getItem('gemini_api_key')) {
            aiIdeaBtn.disabled = true;
            aiIdeaBtn.title = 'Se necesita una API Key para usar esta función.';
            aiIdeaBtn.classList.add('opacity-50');
        }
    }
    
    function checkCanPublish() {
        const { voice, visuals, hook, authenticity } = gameState.currentVideo;
        const ideaText = ideaInput.value.trim();
        const ideaChosen = ideaText || gameState.currentVideo.isAIIdea;
        document.getElementById('publish-video-btn').disabled = !(voice && visuals && hook && authenticity && ideaChosen);
    }
    
    function selectChoice(type, choice, element) {
        gameState.currentVideo[type] = choice;
        const container = element.parentElement;
        container.querySelectorAll('.card').forEach(card => card.style.borderColor = 'rgba(255, 255, 255, 0.1)');
        element.style.borderColor = '#e94560';
        checkCanPublish();
    }
    
    async function callGeminiAPI(prompt) {
        const apiKey = localStorage.getItem('gemini_api_key');
        if (!apiKey) {
            console.log("API Key not found, skipping API call.");
            return "[NO_API_KEY]";
        }

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
        const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            
            if (response.status === 400 || response.status === 403) {
                 handleInvalidApiKey("API Key inválida o mal formada. Por favor, revísala.");
                 return null;
            }
            if (!response.ok) {
                 throw new Error(`API Error: ${response.statusText}`);
            }

            const result = await response.json();
            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) { return result.candidates[0].content.parts[0].text; }
            else { if (result.promptFeedback && result.promptFeedback.blockReason) { return `[CONTENT BLOCKED: ${result.promptFeedback.blockReason}]`; } return "Una idea sobre las últimas tendencias."; }
        } catch (error) { console.error("Error calling Gemini API:", error); return "Una idea sobre cómo empezar."; }
    }
    
    function calculateSimilarity(text1, text2) {
        const stopWords = new Set(['de', 'la', 'el', 'en', 'y', 'a', 'los', 'las', 'un', 'una', 'como', 'para', 'con', 'que', 'es']);
        const words1 = new Set(text1.toLowerCase().split(/\s+/).filter(word => !stopWords.has(word) && word.length > 2));
        const words2 = new Set(text2.toLowerCase().split(/\s+/).filter(word => !stopWords.has(word) && word.length > 2));
        const intersection = new Set([...words1].filter(word => words2.has(word)));
        const union = new Set([...words1, ...words2]);
        if (union.size === 0) return 0;
        return intersection.size / union.size;
    }

    function saveGameState() {
        localStorage.setItem('faceless_simulator_save', JSON.stringify(gameState));
    }

    function loadGameState() {
        const savedGame = localStorage.getItem('faceless_simulator_save');
        if (savedGame) {
            gameState = JSON.parse(savedGame);
            updateStats();
            showScreen('main-game-screen');
            showView('idle-view');
        } else {
            showScreen('start-screen');
        }
    }

    function checkApiKey() {
        const apiKey = localStorage.getItem('gemini_api_key');
        const skipped = localStorage.getItem('gemini_api_key_skipped');
        if (!apiKey && !skipped) {
            showScreen('api-key-screen');
        } else {
            checkSavedGame();
        }
    }
    
    function handleInvalidApiKey(errorMessage) {
        localStorage.removeItem('gemini_api_key');
        const errorP = document.getElementById('api-key-error');
        errorP.textContent = errorMessage;
        errorP.classList.remove('hidden');
        showScreen('api-key-screen');
        publishingOverlay.classList.add('hidden'); 
    }

    function checkSavedGame() {
        if (localStorage.getItem('faceless_simulator_save')) {
            showScreen('continue-prompt-screen');
        } else {
            showScreen('start-screen');
        }
    }

    function initializeGame() {
        const playerEmail = localStorage.getItem('player_email');
        if (!playerEmail) {
            showScreen('email-registration-screen');
        } else {
            checkApiKey();
        }
    }

    function startGame() { resetGameState(); renderNicheSelection(); showScreen('niche-selection-screen'); }
    function selectNiche(niche) { 
        gameState.niche = niche; 
        gameState.money = niche.startingMoney;
        gameState.goal = niche.goal;
        updateStats(); 
        showScreen('main-game-screen'); 
        showView('idle-view'); 
        saveGameState(); 
    }
    function createVideo() { gameState.currentVideo = { idea: '', isAIIdea: false, voice: null, visuals: null, hook: null, authenticity: null }; ideaInput.value = ''; ideaInput.disabled = false; aiIdeaBtn.style.borderColor = 'rgba(255, 255, 255, 0.1)'; renderCreationChoices(); showView('creation-view'); }

    async function publishVideo() {
        publishingOverlay.classList.remove('hidden');
        document.getElementById('publish-video-btn').disabled = true;

        gameState.videos++;
        const { voice, visuals, hook, authenticity } = gameState.currentVideo;
        
        if (!gameState.currentVideo.isAIIdea) {
            gameState.currentVideo.idea = ideaInput.value.trim();
        }

        const toolCost = voice.cost + visuals.cost;
        const totalCost = toolCost + TURN_COST;
        gameState.money -= totalCost;
        
        const moralityPrompt = `Actúa como un estricto moderador de contenido. Analiza este título de video: "${gameState.currentVideo.idea}". ¿Promueve directamente estafas, desinformación peligrosa (médica, financiera), actividades ilegales o incita al odio? No seas demasiado sensible con títulos de marketing o "clickbait". Responde solo "SI" si es claramente dañino o no ético, de lo contrario responde "NO".`;
        const moralityCheckResponse = await callGeminiAPI(moralityPrompt);

        if (moralityCheckResponse === null) return; 
        if (moralityCheckResponse === "[NO_API_KEY]") {
            await proceedWithPublication(totalCost, true, null); // Assume OK if no API key
            return;
        }

        if (moralityCheckResponse.trim().toUpperCase() === "SI") {
            const penaltyFollowers = Math.round(gameState.followers * (0.1 + Math.random() * 0.2));
            const lostFollowers = Math.min(gameState.followers, penaltyFollowers);
            gameState.followers -= lostFollowers;
            displayControversyResults(-lostFollowers, totalCost);
            finalizeTurn();
        } else {
            await proceedWithPublication(totalCost);
        }
    }
    
    async function proceedWithPublication(totalCost) {
        const { voice, visuals, hook, authenticity } = gameState.currentVideo;
        const relevancePrompt = `Actúa como un estratega de contenido. El nicho de mi canal es "${gameState.niche.name}". ¿El siguiente título de video es relevante para este nicho?: "${gameState.currentVideo.idea}". Responde solo "SI" o "NO".`;
        const relevanceCheckResponse = await callGeminiAPI(relevancePrompt);

        if(relevanceCheckResponse === null) return;
        const isRelevant = relevanceCheckResponse === "[NO_API_KEY]" ? true : relevanceCheckResponse.trim().toUpperCase() === "SI";
        
        let aiIdeaCritique = null;
        if (gameState.currentVideo.isAIIdea) {
            const critiquePrompt = `Actúa como un experto en marketing viral. Evalúa este título de video para un canal de ${gameState.niche.name}: "${ideaInput.value}". Da una crítica corta y directa (máximo 15 palabras) sobre su potencial para volverse viral.`;
            aiIdeaCritique = await callGeminiAPI(critiquePrompt);
            if(aiIdeaCritique === null) return;
        }
        
        let repetitionPenaltyMultiplier = 1.0;
        let isRepetitive = false;
        for (const pastIdea of gameState.ideaHistory) {
            if (calculateSimilarity(gameState.currentVideo.idea, pastIdea) > 0.5) {
                repetitionPenaltyMultiplier = 0.4;
                isRepetitive = true;
                break;
            }
        }
        gameState.ideaHistory.push(gameState.currentVideo.idea);
        
        let ideaMultiplier = 1.0;
        if (gameState.currentVideo.isAIIdea) { ideaMultiplier = 1.0; } 
        else { const ideaLength = gameState.currentVideo.idea.length; if (ideaLength < 10) ideaMultiplier = 0.7; else if (ideaLength >= 10 && ideaLength < 50) ideaMultiplier = 1.2; else if (ideaLength >= 50) ideaMultiplier = 1.8; }
        
        const relevanceMultiplier = isRelevant ? 1.0 : 0.1;

        const qualityScore = (voice.quality + visuals.quality) / 2;
        const authenticityScore = (voice.authenticity + authenticity.authenticityBoost) / 2;
        const creativityScore = (visuals.creativity + hook.effectiveness) / 2;
        const baseFollowers = Math.round(((qualityScore + authenticityScore + creativityScore) / 3) * 50 * gameState.niche.popularity / gameState.niche.difficulty);
        const randomFactor = 1 + (Math.random() - 0.5) * 0.4;
        const newFollowers = Math.max(0, Math.round(baseFollowers * randomFactor * ideaMultiplier * repetitionPenaltyMultiplier * relevanceMultiplier));
        gameState.followers += newFollowers;

        const income = Math.floor(gameState.followers / 1000) * (Math.floor(Math.random() * 5) + 1);
        gameState.money += income;
        
        displayResults(newFollowers, income, totalCost, ideaMultiplier, aiIdeaCritique, isRepetitive, isRelevant, baseFollowers);
        finalizeTurn();
    }

    function finalizeTurn() {
        publishingOverlay.classList.add('hidden');
        updateStats();
        showView('results-view');
        saveGameState();
        checkGameOver();
    }
    
    function displayResults(newFollowers, income, totalCost, ideaMultiplier, aiIdeaCritique, isRepetitive, isRelevant, baseFollowers) {
        const container = document.getElementById('results-feedback');
        container.innerHTML = `<div class="fade-in p-4 bg-green-500/20 rounded-lg text-center"><span class="font-bold text-xl text-green-300">+${newFollowers.toLocaleString()}</span> seguidores nuevos</div><div class="fade-in p-4 bg-blue-500/20 rounded-lg text-center" style="animation-delay: 0.2s;"><span class="font-bold text-xl text-blue-300">+$${income.toLocaleString()}</span> de ingresos</div><div class="fade-in p-4 bg-red-500/20 rounded-lg text-center" style="animation-delay: 0.4s;"><span class="font-bold text-xl text-red-300">-$${totalCost.toLocaleString()}</span> de costos totales</div>`;
        
        let ideaFeedback = '';
        if (!isRelevant) {
            ideaFeedback = 'Tu audiencia está confundida. "Este video no tiene nada que ver con lo que sigo este canal..." 🤨';
        } else if (isRepetitive) { 
            ideaFeedback = 'El público lo ha notado... "Hmm, esta idea se parece mucho a tu video anterior." 🥱'; 
        } else if (gameState.currentVideo.isAIIdea) { 
            ideaFeedback = `Crítica de la IA: "${aiIdeaCritique || 'Una idea competente.'}" 🤖`; 
        } else { 
            if (ideaMultiplier >= 1.8) ideaFeedback = '¡Tu idea fue brillante y se hizo viral! 🚀'; 
            else if (ideaMultiplier >= 1.2) ideaFeedback = 'El concepto fue sólido y conectó con la gente. 👍'; 
            else ideaFeedback = 'A la audiencia le costó conectar con la idea esta vez. 🤔'; 
        }

        const ideaFeedbackElement = document.createElement('div');
        ideaFeedbackElement.className = 'fade-in p-4 bg-purple-500/20 rounded-lg text-center';
        ideaFeedbackElement.style.animationDelay = '0.6s';
        ideaFeedbackElement.innerHTML = `<p class="italic text-purple-300">${ideaFeedback}</p>`;
        container.appendChild(ideaFeedbackElement);

        const audienceFeedbackOptions = {
            low: ['"No estuvo mal, pero no me enganchó del todo."', '"Interesante, pero he visto cosas mejores."'],
            medium: ['"¡Buen video! Me ha gustado, sigue así."', '"Aportas valor, te has ganado un like."'],
            high: ['"¡Wow, justo lo que necesitaba! Contenido de calidad."', '"¡Suscrito! Necesito más contenido como este."'],
            viral: ['"¡BRUTAL! Este video tiene que verlo todo el mundo."', '"Compartido, guardado y seguido. ¡Más, por favor!"']
        };
        
        let feedbackTier;
        const potentialFollowers = baseFollowers * ideaMultiplier;
        if (newFollowers > potentialFollowers * 1.2) feedbackTier = 'viral'; else if (newFollowers > potentialFollowers * 0.8) feedbackTier = 'high'; else if (newFollowers > potentialFollowers * 0.4) feedbackTier = 'medium'; else feedbackTier = 'low';
        const randomFeedback = audienceFeedbackOptions[feedbackTier][Math.floor(Math.random() * audienceFeedbackOptions[feedbackTier].length)];
        
        const feedbackElement = document.createElement('div');
        feedbackElement.className = 'fade-in p-4 bg-gray-500/20 rounded-lg text-center';
        feedbackElement.style.animationDelay = '0.8s';
        feedbackElement.innerHTML = `<p class="italic text-gray-300">Comentario del público: ${randomFeedback}</p>`;
        container.appendChild(feedbackElement);
    }

    function displayControversyResults(followerChange, totalCost) {
        const container = document.getElementById('results-feedback');
        container.innerHTML = `<div class="fade-in p-4 bg-red-800/50 rounded-lg text-center"><h4 class="text-xl font-bold text-red-300">¡CONTROVERSIA!</h4><p class="text-red-300">Tu video fue considerado poco ético y ha generado una reacción negativa.</p></div><div class="fade-in p-4 bg-red-500/20 rounded-lg text-center" style="animation-delay: 0.2s;"><span class="font-bold text-xl text-red-300">${followerChange.toLocaleString()}</span> seguidores</div><div class="fade-in p-4 bg-red-500/20 rounded-lg text-center" style="animation-delay: 0.4s;"><span class="font-bold text-xl text-red-300">-$${totalCost.toLocaleString()}</span> de costos totales</div><div class="fade-in p-4 bg-gray-500/20 rounded-lg text-center" style="animation-delay: 0.6s;"><p class="italic text-gray-300">Comentario del público: "¡Esto es inaceptable! Dejando de seguir."</p></div>`;
    }
    
    function checkGameOver() {
        if (gameState.followers >= gameState.goal) {
            gameState.isGameOver = true;
            const goalText = (gameState.goal / 1000000) >= 1 ? `${gameState.goal / 1000000} millón` : `${gameState.goal / 1000}K`;
            document.getElementById('end-screen').querySelector('h1').textContent = '¡Felicidades, Eres una Estrella Faceless! ✨';
            document.getElementById('end-screen').querySelector('p').textContent = `Alcanzaste tu meta de ${goalText} de seguidores con ${gameState.videos} videos. ¡Has dominado el arte del contenido anónimo!`;
            showScreen('end-screen');
        } else if (gameState.money < 0) {
             gameState.isGameOver = true;
             document.getElementById('end-screen').querySelector('h1').textContent = '¡Bancarrota! 💸';
             document.getElementById('end-screen').querySelector('p').textContent = `Te quedaste sin dinero para producir contenido. El camino del creador es duro. ¿Quieres intentarlo de nuevo?`;
             showScreen('end-screen');
        }
    }

    document.getElementById('start-game-btn').addEventListener('click', startGame);
    document.getElementById('restart-game-btn').addEventListener('click', () => { resetGameState(); showScreen('start-screen'); });
    document.getElementById('new-game-btn').addEventListener('click', () => { resetGameState(); showScreen('start-screen'); });
    document.getElementById('continue-game-btn').addEventListener('click', loadGameState);
    document.getElementById('create-video-btn').addEventListener('click', createVideo);
    document.getElementById('publish-video-btn').addEventListener('click', publishVideo);
    document.getElementById('next-turn-btn').addEventListener('click', () => { if (!gameState.isGameOver) { showView('idle-view'); } });
    document.getElementById('save-email-btn').addEventListener('click', async () => {
        const emailInput = document.getElementById('email-input');
        const emailError = document.getElementById('email-error');
        const email = emailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        if (emailRegex.test(email)) {
            emailError.classList.add('hidden');
            const webhookUrl = 'https://demoia.app.n8n.cloud/webhook/register-player';

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email }),
                });

                if (!response.ok) {
                    throw new Error('No se pudo registrar el correo en el servidor.');
                }

                localStorage.setItem('player_email', email);
                checkApiKey();

            } catch (error) {
                console.error('Error al contactar el servidor n8n:', error);
                emailError.textContent = "Error al conectar con el servidor. Inténtalo de nuevo.";
                emailError.classList.remove('hidden');
            }
        } else {
            emailError.textContent = "Por favor, introduce un correo válido.";
            emailError.classList.remove('hidden');
        }
    });

    document.getElementById('save-api-key-btn').addEventListener('click', () => {
        const apiKey = document.getElementById('api-key-input').value.trim();
        if (apiKey) {
            localStorage.setItem('gemini_api_key', apiKey);
            localStorage.removeItem('gemini_api_key_skipped');
            document.getElementById('api-key-error').classList.add('hidden');
            checkSavedGame();
        } else {
            const errorP = document.getElementById('api-key-error');
            errorP.textContent = "Por favor, introduce una API Key válida.";
            errorP.classList.remove('hidden');
        }
    });

    document.getElementById('skip-api-key-btn').addEventListener('click', () => {
        localStorage.setItem('gemini_api_key_skipped', 'true');
        localStorage.removeItem('gemini_api_key');
        checkSavedGame();
    });

    aiIdeaBtn.addEventListener('click', async () => {
        const btnText = aiIdeaBtn.querySelector('.btn-text');
        const loader = aiIdeaBtn.querySelector('.loader-sm');
        aiIdeaBtn.disabled = true;
        btnText.classList.add('hidden');
        loader.classList.remove('hidden');
        
        const prompt = `Genera una idea corta y viral para un título de video para un canal 'faceless' en el nicho de ${gameState.niche.name}. Debe ser pegadizo y de menos de 150 caracteres. Solo dame el titulo nada mas.`;
        const generatedIdea = await callGeminiAPI(prompt);

        if(generatedIdea === null) {
            aiIdeaBtn.disabled = false;
            btnText.classList.remove('hidden');
            loader.classList.add('hidden');
            return;
        }
        
        gameState.currentVideo.isAIIdea = true;
        ideaInput.value = generatedIdea.replace(/"/g, '');
        ideaInput.disabled = true;
        aiIdeaBtn.style.borderColor = '#e94560';
        
        aiIdeaBtn.disabled = false;
        btnText.classList.remove('hidden');
        loader.classList.add('hidden');
        checkCanPublish();
    });

    // Initial load
    initializeGame();
});
</script>

</body>
</html>